<!DOCTYPE html>
<html lang="ar-EG" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>"Ù…Ø³Ø§Ø¨Ù‚Ø© Ù…Ù‡Ø±Ø¬Ø§Ù† Ø§Ù„ÙƒØ±Ø§Ø²Ù‡ Ø§Ù„Ù…Ø±Ù‚Ø³ÙŠØ©"</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Cairo', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        }
        .card {
            background-color: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 1.5rem;
            padding: 2.5rem;
            box-shadow: 0 25px 50px -12px rgb(0 0 0 / 0.25);
            transition: all 0.5s ease;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .screen {
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
        }
        .screen.hidden {
            opacity: 0;
            pointer-events: none;
            position: absolute;
            width: 100%;
            transform: scale(0.95);
        }
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            text-align: center;
            padding: 0.85rem 1rem;
            border-radius: 0.75rem;
            font-weight: 700;
            transition: all 0.3s ease;
            cursor: pointer;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .btn-primary {
            background-color: #5D3EBF;
            color: white;
        }
        .btn-primary:hover {
            background-color: #4C2F99;
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .btn-secondary {
            background-color: #e5e7eb;
            color: #374151;
        }
        .btn-secondary:hover {
            background-color: #d1d5db;
        }
        .btn-danger {
            background-color: #ef4444;
            color: white;
        }
        .btn-danger:hover {
            background-color: #dc2626;
        }
        .category-btn {
            background-color: #ffffff;
            border: 1px solid #e5e7eb;
            color: #374151;
            font-weight: 600;
            padding: 1.5rem;
        }
        .category-btn:hover {
            background-color: #5D3EBF;
            border-color: #5D3EBF;
            color: white;
            transform: scale(1.03);
        }
        .option-btn {
            border: 2px solid #e5e7eb;
            background-color: white;
            text-align: right;
            font-size: 1.1rem;
        }
        .option-btn:hover:not([disabled]) {
            border-color: #5D3EBF;
            background-color: #f4f1fe;
        }
        .option-btn.correct {
            background-color: #dcfce7;
            border-color: #22c55e;
            color: #166534;
            font-weight: 700;
        }
        .option-btn.incorrect {
            background-color: #fee2e2;
            border-color: #ef4444;
            color: #991b1b;
            font-weight: 700;
        }
        .option-btn:disabled {
            cursor: not-allowed;
        }
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #5D3EBF;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        .modal-overlay.visible {
            opacity: 1;
            pointer-events: auto;
        }
        .modal-content {
            transform: scale(0.95);
            transition: transform 0.3s ease;
        }
        .modal-overlay.visible .modal-content {
            transform: scale(1);
        }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen p-4">

    <div id="app" class="w-full max-w-2xl mx-auto relative">

        <!-- Header for main app screens -->
        <div id="app-header" class="flex items-center justify-between w-full mb-4 px-4 h-16 hidden">
            <div class="flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#5D3EBF" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-cross"><path d="M11 2a2 2 0 0 0-2 2v5H4a2 2 0 0 0-2 2v2c0 1.1.9 2 2 2h5v5c0 1.1.9 2 2 2h2a2 2 0 0 0 2-2v-5h5a2 2 0 0 0 2-2v-2a2 2 0 0 0-2-2h-5V4a2 2 0 0 0-2-2h-2z"/></svg>
                <h2 class="text-lg font-bold text-purple-900 hidden sm:block">ÙƒÙ†ÙŠØ³Ø© Ø§Ù„Ø³ÙŠØ¯Ø© Ø§Ù„Ø¹Ø°Ø±Ø§Ø¡ Ù…Ø±ÙŠÙ… Ø¨Ø±ÙˆØ¶ Ø§Ù„ÙØ±Ø¬</h2>
            </div>
            <button id="logout-btn" class="text-sm font-semibold text-purple-700 hover:text-purple-900 transition">ØªØºÙŠÙŠØ± Ø§Ù„Ù„Ø§Ø¹Ø¨</button>
        </div>

        <!-- User Selection Screen -->
        <div id="user-selection-screen" class="screen card text-center">
            <div class="flex flex-col items-center justify-center w-full mb-6 px-4">
                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#5D3EBF" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-cross"><path d="M11 2a2 2 0 0 0-2 2v5H4a2 2 0 0 0-2 2v2c0 1.1.9 2 2 2h5v5c0 1.1.9 2 2 2h2a2 2 0 0 0 2-2v-5h5a2 2 0 0 0 2-2v-2a2 2 0 0 0-2-2h-5V4a2 2 0 0 0-2-2h-2z"/></svg>
                <h2 class="text-xl sm:text-2xl font-bold text-purple-900 mt-3">ÙƒÙ†ÙŠØ³Ø© Ø§Ù„Ø³ÙŠØ¯Ø© Ø§Ù„Ø¹Ø°Ø±Ø§Ø¡ Ù…Ø±ÙŠÙ… Ø¨Ø±ÙˆØ¶ Ø§Ù„ÙØ±Ø¬</h2>
            </div>
            <h1 class="text-3xl font-bold mb-2 text-gray-900">Ø§Ø®ØªØ± Ø§Ù„Ù„Ø§Ø¹Ø¨</h1>
            <p class="text-gray-600 mb-6">Ø§Ø®ØªØ± Ø§Ø³Ù…Ùƒ Ø£Ùˆ Ø£Ø¶Ù Ù„Ø§Ø¹Ø¨Ù‹Ø§ Ø¬Ø¯ÙŠØ¯Ù‹Ø§.</p>
            <div id="user-list" class="space-y-3 mb-6">
                <!-- User profiles will be injected here -->
            </div>
            <button id="show-add-user-modal-btn" class="btn btn-primary">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus mr-2"><path d="M5 12h14"/><path d="M12 5v14"/></svg>
                Ø¥Ø¶Ø§ÙØ© Ù„Ø§Ø¹Ø¨ Ø¬Ø¯ÙŠØ¯
            </button>
        </div>

        <!-- Category Selection Screen -->
        <div id="category-screen" class="screen hidden">
             <div class="card">
                 <div class="text-center mb-8">
                     <h1 class="text-3xl font-bold text-gray-900">Ø£Ù‡Ù„Ø§Ù‹ Ø¨ÙƒØŒ <span id="username-display"></span>!</h1>
                     <p class="text-gray-600 mt-2">Ø§Ø®ØªØ± Ø£Ø­Ø¯ Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© Ù„Ù„Ø¨Ø¯Ø¡.</p>
                 </div>
                 <div id="categories" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                     <!-- Categories will be injected here by JS -->
                 </div>
             </div>
        </div>

        <!-- Quiz Screen -->
        <div id="quiz-screen" class="screen hidden">
            <div class="card">
                <div id="quiz-loading" class="flex flex-col items-center justify-center h-64">
                    <div class="loader mb-4"></div>
                    <p class="text-gray-600 text-lg">Ø¬Ø§Ø±ÙŠ ØªØ­Ø¶ÙŠØ± Ø§Ù„Ø£Ø³Ø¦Ù„Ø©...</p>
                </div>
                <div id="quiz-content" class="hidden">
                    <div class="flex justify-between items-center mb-6">
                        <div>
                            <p class="text-sm text-gray-500">Ø³Ø¤Ø§Ù„ <span id="question-number"></span> Ù…Ù† <span id="total-questions"></span></p>
                            <h2 id="quiz-category-title" class="text-2xl font-bold text-purple-800"></h2>
                        </div>
                        <div class="text-left">
                             <p class="text-sm text-gray-500">Ø§Ù„Ù†Ù‚Ø§Ø·</p>
                             <p id="score-display" class="text-2xl font-bold">0</p>
                        </div>
                    </div>
                    <p id="question-text" class="text-xl font-semibold mb-6 min-h-[6rem] leading-relaxed"></p>
                    <div id="options-container" class="space-y-3">
                        <!-- Options will be injected here -->
                    </div>
                    <div id="feedback" class="mt-6 text-center font-semibold text-xl"></div>
                </div>
            </div>
        </div>

        <!-- Score Screen -->
        <div id="score-screen" class="screen hidden">
            <div class="card text-center">
                <h1 class="text-3xl font-bold mb-2 text-gray-900">Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±!</h1>
                <p class="text-gray-600 mb-6">Ù‡Ø°Ù‡ Ù‡ÙŠ Ù†ØªÙŠØ¬ØªÙƒ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©.</p>
                <div class="bg-purple-50 p-6 rounded-xl mb-6 border border-purple-200">
                    <p class="text-lg text-purple-800">Ù…Ø¬Ù…ÙˆØ¹ Ù†Ù‚Ø§Ø·Ùƒ</p>
                    <p id="final-score" class="text-6xl font-bold text-purple-600 my-2">0</p>
                    <p id="high-score-message" class="text-lg font-semibold text-amber-600 hidden animate-pulse">ğŸ‰ Ø±Ù‚Ù… Ù‚ÙŠØ§Ø³ÙŠ Ø¬Ø¯ÙŠØ¯! ğŸ‰</p>
                </div>
                <div class="flex flex-col sm:flex-row gap-3">
                    <button id="play-again-btn" class="btn btn-primary flex-1">Ø§Ù„Ø¹Ø¨ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰</button>
                    <button id="change-category-btn" class="btn btn-secondary flex-1">ØªØºÙŠÙŠØ± Ø§Ù„Ù‚Ø³Ù…</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit User Modal -->
    <div id="user-modal" class="modal-overlay">
        <div class="modal-content card w-full max-w-sm text-center">
            <h2 id="user-modal-title" class="text-2xl font-bold mb-4">Ø¥Ø¶Ø§ÙØ© Ù„Ø§Ø¹Ø¨ Ø¬Ø¯ÙŠØ¯</h2>
            <input type="text" id="username-input" placeholder="Ø§Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨" class="w-full text-center px-4 py-3 border border-gray-300 rounded-xl mb-4 focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
            <div class="flex gap-3">
                <button id="save-user-btn" class="btn btn-primary flex-1">Ø­ÙØ¸</button>
                <button id="cancel-user-modal-btn" class="btn btn-secondary flex-1">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>
    
    <!-- Delete Confirmation Modal -->
    <div id="delete-modal" class="modal-overlay">
        <div class="modal-content card w-full max-w-sm text-center">
            <h2 class="text-2xl font-bold mb-2">Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ</h2>
            <p class="text-gray-600 mb-6">Ø³ÙŠØªÙ… Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù„Ø§Ø¹Ø¨ ÙˆØ¬Ù…ÙŠØ¹ Ù†Ù‚Ø§Ø·Ù‡ Ø§Ù„Ù…Ø³Ø¬Ù„Ø© Ù†Ù‡Ø§Ø¦ÙŠÙ‹Ø§.</p>
            <div class="flex gap-3">
                <button id="confirm-delete-btn" class="btn btn-danger flex-1">Ù†Ø¹Ù…ØŒ Ø§Ø­Ø°Ù</button>
                <button id="cancel-delete-btn" class="btn btn-secondary flex-1">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>

    <footer class="text-center text-gray-600 text-sm mt-8 pb-4">
        <p>ÙÙŠÙ„ÙˆØ¨Ø§ØªÙŠØ± Ø´Ø§Ù‡Ø± </p>
    </footer>

    <script>
        // --- DOM Elements ---
        const appContainer = document.getElementById('app');
        const appHeader = document.getElementById('app-header');
        const userSelectionScreen = document.getElementById('user-selection-screen');
        const categoryScreen = document.getElementById('category-screen');
        const quizScreen = document.getElementById('quiz-screen');
        const scoreScreen = document.getElementById('score-screen');

        const userListContainer = document.getElementById('user-list');
        const showAddUserModalBtn = document.getElementById('show-add-user-modal-btn');
        const logoutBtn = document.getElementById('logout-btn');

        const userModal = document.getElementById('user-modal');
        const userModalTitle = document.getElementById('user-modal-title');
        const usernameInput = document.getElementById('username-input');
        const saveUserBtn = document.getElementById('save-user-btn');
        const cancelUserModalBtn = document.getElementById('cancel-user-modal-btn');
        
        const deleteModal = document.getElementById('delete-modal');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');

        const usernameDisplay = document.getElementById('username-display');
        const categoriesContainer = document.getElementById('categories');

        const quizLoading = document.getElementById('quiz-loading');
        const quizContent = document.getElementById('quiz-content');
        const quizCategoryTitle = document.getElementById('quiz-category-title');
        const questionNumber = document.getElementById('question-number');
        const totalQuestions = document.getElementById('total-questions');
        const scoreDisplay = document.getElementById('score-display');
        const questionText = document.getElementById('question-text');
        const optionsContainer = document.getElementById('options-container');
        const feedback = document.getElementById('feedback');

        const finalScore = document.getElementById('final-score');
        const highScoreMessage = document.getElementById('high-score-message');
        const playAgainBtn = document.getElementById('play-again-btn');
        const changeCategoryBtn = document.getElementById('change-category-btn');

        // --- App State ---
        let state = {
            users: [], // { id, name }
            currentUser: null, // { id, name }
            currentCategory: null,
            questions: [],
            currentQuestionIndex: 0,
            score: 0,
            highScores: {}, // { userId: { category: score } }
            editingUserId: null,
            deletingUserId: null,
        };

        const QUIZ_CATEGORIES = [
            "Ø§Ù„Ù„Ø§Ù‡ÙˆØª Ø§Ù„Ù‚Ø¨Ø·ÙŠ", "ØªØ§Ø±ÙŠØ® Ø§Ù„ÙƒÙ†ÙŠØ³Ø©", "Ø§Ù„Ø·Ù‚Ø³ Ø§Ù„Ù‚Ø¨Ø·ÙŠ",
            "Ø§Ù„Ù‚Ø¯ÙŠØ³ÙŠÙ† ÙˆØ§Ù„Ø´Ù‡Ø¯Ø§Ø¡", "Ø§Ù„ÙƒØªØ§Ø¨ Ø§Ù„Ù…Ù‚Ø¯Ø³"
        ];
        const NUM_QUESTIONS = 10;

        // --- Initialization ---
        function init() {
            loadData();
            renderUserList();
            showScreen('user-selection');
            populateCategories();
            addEventListeners();
        }

        function addEventListeners() {
            showAddUserModalBtn.addEventListener('click', () => showUserModal());
            saveUserBtn.addEventListener('click', handleSaveUser);
            cancelUserModalBtn.addEventListener('click', hideUserModal);
            
            confirmDeleteBtn.addEventListener('click', handleDeleteUser);
            cancelDeleteBtn.addEventListener('click', hideDeleteModal);

            logoutBtn.addEventListener('click', logout);
            playAgainBtn.addEventListener('click', handlePlayAgain);
            changeCategoryBtn.addEventListener('click', () => showScreen('category'));
        }

        // --- Screen Management ---
        function showScreen(screenName) {
            const screens = appContainer.querySelectorAll('.screen');
            screens.forEach(screen => {
                screen.classList.toggle('hidden', screen.id !== `${screenName}-screen`);
            });
            appHeader.classList.toggle('hidden', screenName === 'user-selection');
        }

        // --- Data Handling (localStorage) ---
        function loadData() {
            const users = localStorage.getItem('copticQuizUsers');
            const highScores = localStorage.getItem('copticQuizHighScores');
            if (users) state.users = JSON.parse(users);
            if (highScores) state.highScores = JSON.parse(highScores);
        }

        function saveData() {
            localStorage.setItem('copticQuizUsers', JSON.stringify(state.users));
            localStorage.setItem('copticQuizHighScores', JSON.stringify(state.highScores));
        }

        // --- User Management ---
        function renderUserList() {
            userListContainer.innerHTML = '';
            if (state.users.length === 0) {
                userListContainer.innerHTML = `<p class="text-gray-500">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù„Ø§Ø¹Ø¨ÙˆÙ†. Ø£Ø¶Ù Ù„Ø§Ø¹Ø¨Ù‹Ø§ Ø¬Ø¯ÙŠØ¯Ù‹Ø§ Ù„Ù„Ø¨Ø¯Ø¡!</p>`;
                return;
            }
            state.users.forEach(user => {
                const userEl = document.createElement('div');
                userEl.className = 'flex items-center gap-2';
                userEl.innerHTML = `
                    <button class="btn btn-secondary flex-grow text-lg">${user.name}</button>
                    <button class="p-2 text-gray-500 hover:text-purple-600 transition" data-action="edit" data-id="${user.id}" aria-label="ØªØ¹Ø¯ÙŠÙ„">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg>
                    </button>
                    <button class="p-2 text-gray-500 hover:text-red-600 transition" data-action="delete" data-id="${user.id}" aria-label="Ø­Ø°Ù">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
                    </button>
                `;
                userListContainer.appendChild(userEl);

                userEl.querySelector('.btn-secondary').addEventListener('click', () => login(user.id));
            });
            
            userListContainer.addEventListener('click', (e) => {
                const button = e.target.closest('button[data-action]');
                if (!button) return;
                
                const action = button.dataset.action;
                const id = button.dataset.id;
                
                if (action === 'edit') showUserModal(id);
                if (action === 'delete') showDeleteModal(id);
            });
        }

        function showUserModal(userId = null) {
            state.editingUserId = userId;
            if (userId) {
                const user = state.users.find(u => u.id === userId);
                userModalTitle.textContent = 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨';
                usernameInput.value = user.name;
            } else {
                userModalTitle.textContent = 'Ø¥Ø¶Ø§ÙØ© Ù„Ø§Ø¹Ø¨ Ø¬Ø¯ÙŠØ¯';
                usernameInput.value = '';
            }
            userModal.classList.add('visible');
            usernameInput.focus();
        }

        function hideUserModal() {
            userModal.classList.remove('visible');
            state.editingUserId = null;
        }
        
        function showDeleteModal(userId) {
            state.deletingUserId = userId;
            deleteModal.classList.add('visible');
        }

        function hideDeleteModal() {
            deleteModal.classList.remove('visible');
            state.deletingUserId = null;
        }

        function handleSaveUser() {
            const name = usernameInput.value.trim();
            if (!name) {
                usernameInput.classList.add('border-red-500');
                setTimeout(() => usernameInput.classList.remove('border-red-500'), 2000);
                return;
            }

            if (state.editingUserId) { // Editing existing user
                const user = state.users.find(u => u.id === state.editingUserId);
                if (user) user.name = name;
            } else { // Adding new user
                const newUser = { id: `user_${Date.now()}`, name };
                state.users.push(newUser);
            }
            
            saveData();
            renderUserList();
            hideUserModal();
        }
        
        function handleDeleteUser() {
            if (!state.deletingUserId) return;
            state.users = state.users.filter(u => u.id !== state.deletingUserId);
            if (state.highScores[state.deletingUserId]) {
                delete state.highScores[state.deletingUserId];
            }
            state.deletingUserId = null;
            saveData();
            renderUserList();
            hideDeleteModal();
        }
        
        function login(userId) {
            const user = state.users.find(u => u.id === userId);
            if (user) {
                state.currentUser = user;
                usernameDisplay.textContent = user.name;
                showScreen('category');
            }
        }
        
        function logout() {
            state.currentUser = null;
            showScreen('user-selection');
        }

        // --- Category Screen ---
        function populateCategories() {
            categoriesContainer.innerHTML = '';
            QUIZ_CATEGORIES.forEach(category => {
                const button = document.createElement('button');
                button.className = 'btn category-btn';
                button.textContent = category;
                button.addEventListener('click', () => startQuiz(category));
                categoriesContainer.appendChild(button);
            });
            if (QUIZ_CATEGORIES.length % 2 !== 0 && categoriesContainer.lastElementChild) {
                categoriesContainer.lastElementChild.classList.add('sm:col-span-2');
            }
        }

        // --- Quiz Logic ---
        async function startQuiz(category) {
            state.currentCategory = category;
            resetQuizState();
            showScreen('quiz');
            quizContent.classList.add('hidden');
            quizLoading.classList.remove('hidden');
            quizLoading.querySelector('p').textContent = 'Ø¬Ø§Ø±ÙŠ ØªØ­Ø¶ÙŠØ± Ø§Ù„Ø£Ø³Ø¦Ù„Ø©...';

            try {
                const generatedQuestions = await fetchQuestions(category);
                state.questions = generatedQuestions;
                if (state.questions && state.questions.length > 0) {
                    quizLoading.classList.add('hidden');
                    quizContent.classList.remove('hidden');
                    displayCurrentQuestion();
                } else {
                   throw new Error("No questions were generated.");
                }
            } catch (error) {
                console.error("Error fetching questions:", error);
                quizLoading.innerHTML = `<p class="text-red-500 text-center">Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¶ÙŠØ± Ø§Ù„Ø£Ø³Ø¦Ù„Ø©. Ø¨Ø±Ø¬Ø§Ø¡ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.</p><button onclick="startQuiz('${category}')" class="btn btn-primary mt-4">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©</button>`;
            }
        }

        function resetQuizState() {
            state.questions = [];
            state.currentQuestionIndex = 0;
            state.score = 0;
            scoreDisplay.textContent = '0';
            feedback.textContent = '';
            highScoreMessage.classList.add('hidden');
        }
        
        function displayCurrentQuestion() {
            if (state.currentQuestionIndex >= state.questions.length) {
                endQuiz();
                return;
            }

            const question = state.questions[state.currentQuestionIndex];
            quizCategoryTitle.textContent = state.currentCategory;
            questionNumber.textContent = state.currentQuestionIndex + 1;
            totalQuestions.textContent = state.questions.length;
            questionText.textContent = question.question_text;
            
            optionsContainer.innerHTML = '';
            question.options.forEach((option, index) => {
                const button = document.createElement('button');
                button.className = 'btn option-btn';
                button.textContent = option;
                button.dataset.index = index;
                button.addEventListener('click', handleAnswer);
                optionsContainer.appendChild(button);
            });
        }

        function handleAnswer(event) {
            const selectedButton = event.target;
            const selectedIndex = parseInt(selectedButton.dataset.index);
            const correctIndex = state.questions[state.currentQuestionIndex].correct_answer_index;

            const optionButtons = optionsContainer.querySelectorAll('.option-btn');
            optionButtons.forEach(btn => btn.disabled = true);

            if (selectedIndex === correctIndex) {
                state.score += 10;
                scoreDisplay.textContent = state.score;
                selectedButton.classList.add('correct');
                feedback.textContent = "Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©!";
                feedback.className = "mt-6 text-center font-semibold text-xl text-green-600";
            } else {
                selectedButton.classList.add('incorrect');
                optionButtons[correctIndex].classList.add('correct');
                feedback.textContent = "Ø¥Ø¬Ø§Ø¨Ø© Ø®Ø§Ø·Ø¦Ø©!";
                feedback.className = "mt-6 text-center font-semibold text-xl text-red-600";
            }

            setTimeout(() => {
                state.currentQuestionIndex++;
                feedback.textContent = '';
                displayCurrentQuestion();
            }, 2000);
        }

        function endQuiz() {
            finalScore.textContent = state.score;
            const userId = state.currentUser.id;
            
            if (!state.highScores[userId]) {
                state.highScores[userId] = {};
            }
            
            const currentHighScore = state.highScores[userId][state.currentCategory] || 0;
            
            if (state.score > currentHighScore) {
                state.highScores[userId][state.currentCategory] = state.score;
                highScoreMessage.classList.remove('hidden');
                saveData();
            }
            showScreen('score');
        }

        function handlePlayAgain() {
            startQuiz(state.currentCategory);
        }

        // --- Gemini API Integration ---
        async function fetchQuestions(category) {
            const prompt = `Ù‚Ù… Ø¨Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù…ÙˆØ¹Ø© Ù…Ù† ${NUM_QUESTIONS} Ø£Ø³Ø¦Ù„Ø© Ø§Ø®ØªØ¨Ø§Ø± ÙØ±ÙŠØ¯Ø© Ù…Ù† Ù†ÙˆØ¹Ù‡Ø§ ÙˆÙ…ØªØ¹Ø¯Ø¯Ø© Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© Ø­ÙˆÙ„ Ù…ÙˆØ¶ÙˆØ¹ "${category}" ÙÙŠ Ø³ÙŠØ§Ù‚ Ø§Ù„ÙƒÙ†ÙŠØ³Ø© Ø§Ù„Ù‚Ø¨Ø·ÙŠØ© Ø§Ù„Ø£Ø±Ø«ÙˆØ°ÙƒØ³ÙŠØ©. ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ù…ØªÙˆØ³Ø·Ø© Ø§Ù„ØµØ¹ÙˆØ¨Ø©. Ù„ÙƒÙ„ Ø³Ø¤Ø§Ù„ØŒ Ù‚Ø¯Ù… Ø£Ø±Ø¨Ø¹Ø© Ø®ÙŠØ§Ø±Ø§Øª Ø¥Ø¬Ø§Ø¨Ø© Ù…Ù…ÙŠØ²Ø©ØŒ Ù…Ø¹ ÙˆØ¬ÙˆØ¯ Ø¥Ø¬Ø§Ø¨Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø· ØµØ­ÙŠØ­Ø©. ØªØ£ÙƒØ¯ Ù…Ù† ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© Ø¨ÙˆØ¶ÙˆØ­. Ù‚Ù… Ø¨Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø© Ù…Ù† Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ÙˆØ§Ù„Ø£Ø¬ÙˆØ¨Ø© ÙÙŠ ÙƒØ§Ø¦Ù† JSON ÙˆØ§Ø­Ø¯ ØµØ§Ù„Ø­.`;

            const payload = {
                contents: [{
                    role: "user",
                    parts: [{ text: prompt }]
                }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            "quiz_title": { "type": "STRING" },
                            "questions": {
                                "type": "ARRAY",
                                "items": {
                                    "type": "OBJECT",
                                    "properties": {
                                        "question_text": { "type": "STRING" },
                                        "options": {
                                            "type": "ARRAY",
                                            "items": { "type": "STRING" }
                                        },
                                        "correct_answer_index": { "type": "INTEGER" }
                                    },
                                    "required": ["question_text", "options", "correct_answer_index"]
                                }
                            }
                        },
                        "required": ["quiz_title", "questions"]
                    }
                }
            };
            
            const apiKey = "AIzaSyDvly2fECmto7sYTKD-QYJxUlF3Ly_kQNY"; // API key is handled by the environment
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            let attempts = 0;
            let delay = 1000;

            while (attempts < 5) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        const result = await response.json();
                        if (result.candidates && result.candidates[0]?.content?.parts?.[0]) {
                            const jsonText = result.candidates[0].content.parts[0].text;
                            const parsedJson = JSON.parse(jsonText);
                            return parsedJson.questions;
                        } else {
                            throw new Error("Invalid response structure from API.");
                        }
                    } else if (response.status === 429 || response.status >= 500) {
                        await new Promise(res => setTimeout(res, delay));
                        delay *= 2;
                        attempts++;
                    } else {
                        throw new Error(`API request failed with status: ${response.status}`);
                    }
                } catch (error) {
                    console.error(`Attempt ${attempts + 1} failed:`, error);
                    await new Promise(res => setTimeout(res, delay));
                    delay *= 2;
                    attempts++;
                }
            }
            
            throw new Error("Failed to fetch questions from the API after multiple retries.");
        }

        // --- Start the App ---
        init();
    </script>
</body>
</html>
